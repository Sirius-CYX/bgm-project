<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gain å‰Šæ³¢å¯¹æ¯”æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .controls {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      justify-content: center;
    }

    .file-upload {
      position: relative;
    }

    .file-upload input[type="file"] {
      display: none;
    }

    .file-upload label {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: bold;
    }

    .file-upload label:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .gain-selector {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .gain-option {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
      font-size: 1.1em;
    }

    .gain-option:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .gain-option.active {
      background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
      border-color: white;
      box-shadow: 0 0 20px rgba(245, 87, 108, 0.5);
    }

    .gain-option.danger {
      border-color: #ff4444;
    }

    .gain-option.safe {
      border-color: #44ff44;
    }

    .play-controls {
      display: flex;
      gap: 10px;
    }

    button {
      padding: 12px 24px;
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
      font-size: 1em;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      text-align: center;
      margin: 15px 0;
      font-size: 1.1em;
      min-height: 30px;
    }

    .visualization-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .visualization-container {
        grid-template-columns: 1fr;
      }
    }

    .visualization-box {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
    }

    .visualization-box h2 {
      margin-bottom: 15px;
      text-align: center;
      font-size: 1.5em;
    }

    canvas {
      width: 100%;
      height: 300px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      display: block;
    }

    .info-panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
    }

    .info-panel h3 {
      margin-bottom: 15px;
      color: #ffd700;
    }

    .info-panel ul {
      list-style: none;
      padding-left: 0;
    }

    .info-panel li {
      margin: 10px 0;
      padding-left: 25px;
      position: relative;
    }

    .info-panel li:before {
      content: "â–¶";
      position: absolute;
      left: 0;
      color: #4facfe;
    }

    .clipping-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 10px;
      background: #44ff44;
      animation: pulse 2s infinite;
    }

    .clipping-indicator.active {
      background: #ff4444;
      animation: pulse-fast 0.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes pulse-fast {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸµ Gain å‰Šæ³¢å¯¹æ¯”æµ‹è¯•</h1>
    
    <div class="controls">
      <div class="file-upload">
        <input type="file" id="audioFile" accept="audio/*" />
        <label for="audioFile">é€‰æ‹©éŸ³ä¹æ–‡ä»¶</label>
      </div>
      
      <div class="gain-selector">
        <div class="gain-option" data-gain="1.0" id="gain1.0">
          Gain: 1.0 <span class="clipping-indicator" id="indicator1.0"></span>
        </div>
        <div class="gain-option active" data-gain="0.85" id="gain0.85">
          Gain: 0.85 <span class="clipping-indicator" id="indicator0.85"></span>
        </div>
      </div>
      
      <div class="play-controls">
        <button id="playBtn">æ’­æ”¾</button>
        <button id="stopBtn">åœæ­¢</button>
      </div>
    </div>

    <div class="status" id="status">è¯·å…ˆä¸Šä¼ éŸ³ä¹æ–‡ä»¶</div>

    <div class="visualization-container">
      <div class="visualization-box">
        <h2>æ³¢å½¢å›¾ (Waveform)</h2>
        <canvas id="waveformCanvas"></canvas>
      </div>
      <div class="visualization-box">
        <h2>é¢‘è°±å›¾ (Frequency Spectrum)</h2>
        <canvas id="spectrumCanvas"></canvas>
      </div>
    </div>

    <div class="info-panel">
      <h3>ğŸ“Š æµ‹è¯•è¯´æ˜</h3>
      <ul>
        <li><strong>Gain 1.0:</strong> å¯èƒ½å¯¼è‡´å‰Šæ³¢å¤±çœŸï¼Œæ³¢å½¢ä¼šè¢«"å‰Šå¹³"ï¼ˆè¶…è¿‡ Â±1.0 çš„éƒ¨åˆ†è¢«æˆªæ–­ï¼‰</li>
        <li><strong>Gain 0.85:</strong> å®‰å…¨å¢ç›Šå€¼ï¼Œé¿å…æ•°å­—å‰Šæ³¢ï¼Œä¿æŒéŸ³é¢‘è´¨é‡</li>
        <li><strong>æ³¢å½¢å›¾:</strong> æ˜¾ç¤ºæ—¶åŸŸä¿¡å·ï¼Œå‰Šæ³¢æ—¶ä¼šå‡ºç°æ˜æ˜¾çš„å¹³é¡¶</li>
        <li><strong>é¢‘è°±å›¾:</strong> æ˜¾ç¤ºé¢‘åŸŸåˆ†æï¼Œå‰Šæ³¢ä¼šäº§ç”Ÿé«˜é¢‘è°æ³¢å¤±çœŸ</li>
        <li><strong>å‰Šæ³¢æŒ‡ç¤ºå™¨:</strong> çº¢è‰²é—ªçƒè¡¨ç¤ºæ£€æµ‹åˆ°å‰Šæ³¢ï¼Œç»¿è‰²è¡¨ç¤ºæ­£å¸¸</li>
      </ul>
    </div>
  </div>

  <script>
    // è·å– DOM å…ƒç´ 
    const audioFileInput = document.getElementById('audioFile');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const status = document.getElementById('status');
    const waveformCanvas = document.getElementById('waveformCanvas');
    const spectrumCanvas = document.getElementById('spectrumCanvas');
    const gainOptions = document.querySelectorAll('.gain-option');

    // éŸ³é¢‘ä¸Šä¸‹æ–‡å’ŒèŠ‚ç‚¹
    let audioContext = null;
    let audioBuffer = null;
    let sourceNode = null;
    let gainNode = null;
    let analyserNode = null;
    let isPlaying = false;
    let currentGain = 0.85;
    let animationFrameId = null;

    // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
    function initAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioContext;
    }

    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    audioFileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        status.textContent = 'æ­£åœ¨åŠ è½½éŸ³ä¹æ–‡ä»¶...';
        
        // åœæ­¢å½“å‰æ’­æ”¾
        stopPlayback();
        
        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        const ctx = initAudioContext();
        
        // è¯»å–æ–‡ä»¶
        const arrayBuffer = await file.arrayBuffer();
        audioBuffer = await ctx.decodeAudioData(arrayBuffer);
        
        status.textContent = `éŸ³ä¹åŠ è½½æˆåŠŸï¼æ–‡ä»¶ï¼š${file.name}`;
        playBtn.disabled = false;
        stopBtn.disabled = false;
        
        console.log('éŸ³é¢‘æ–‡ä»¶åŠ è½½å®Œæˆ');
      } catch (error) {
        console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', error);
        status.textContent = 'éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼';
      }
    });

    // åˆ›å»ºéŸ³é¢‘é“¾è·¯ï¼šPlayer â†’ Gain â†’ AnalyserNode â†’ Destination
    function createAudioChain(gainValue) {
      if (!audioBuffer) {
        status.textContent = 'è¯·å…ˆä¸Šä¼ éŸ³ä¹æ–‡ä»¶';
        return;
      }

      const ctx = initAudioContext();
      
      // å¦‚æœä¸Šä¸‹æ–‡è¢«æš‚åœï¼Œéœ€è¦ç”¨æˆ·äº¤äº’åæ¢å¤
      if (ctx.state === 'suspended') {
        ctx.resume();
      }

      // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
      stopPlayback();

      // åˆ›å»ºéŸ³é¢‘æºèŠ‚ç‚¹ï¼ˆä½¿ç”¨ BufferSourceï¼‰
      sourceNode = ctx.createBufferSource();
      sourceNode.buffer = audioBuffer;
      sourceNode.loop = false; // ä¸å¾ªç¯æ’­æ”¾

      // åˆ›å»º Gain èŠ‚ç‚¹
      gainNode = ctx.createGain();
      gainNode.gain.value = gainValue;
      currentGain = gainValue;

      // åˆ›å»º AnalyserNode ç”¨äºå¯è§†åŒ–
      analyserNode = ctx.createAnalyser();
      analyserNode.fftSize = 2048; // å¿«é€Ÿå‚…é‡Œå¶å˜æ¢å¤§å°
      analyserNode.smoothingTimeConstant = 0.8; // å¹³æ»‘æ—¶é—´å¸¸æ•°

      // è¿æ¥éŸ³é¢‘é“¾è·¯ï¼šSource â†’ Gain â†’ Analyser â†’ Destination
      sourceNode.connect(gainNode);
      gainNode.connect(analyserNode);
      analyserNode.connect(ctx.destination);

      // æ’­æ”¾ç»“æŸäº‹ä»¶
      sourceNode.onended = () => {
        isPlaying = false;
        playBtn.textContent = 'æ’­æ”¾';
        status.textContent = 'æ’­æ”¾å®Œæˆ';
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
        }
      };

      // å¼€å§‹æ’­æ”¾
      sourceNode.start(0);
      isPlaying = true;
      playBtn.textContent = 'æš‚åœ';
      status.textContent = `æ­£åœ¨æ’­æ”¾... (Gain: ${gainValue})`;

      // å¼€å§‹å¯è§†åŒ–
      startVisualization();
    }

    // åœæ­¢æ’­æ”¾
    function stopPlayback() {
      if (sourceNode) {
        try {
          sourceNode.stop();
        } catch (e) {
          // å¦‚æœå·²ç»åœæ­¢ï¼Œå¿½ç•¥é”™è¯¯
        }
        sourceNode.disconnect();
        sourceNode = null;
      }
      
      if (gainNode) {
        gainNode.disconnect();
        gainNode = null;
      }
      
      if (analyserNode) {
        analyserNode.disconnect();
        analyserNode = null;
      }

      isPlaying = false;
      playBtn.textContent = 'æ’­æ”¾';
      
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }

      // æ¸…ç©ºç”»å¸ƒ
      const waveformCtx = waveformCanvas.getContext('2d');
      const spectrumCtx = spectrumCanvas.getContext('2d');
      waveformCtx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
      spectrumCtx.clearRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);
    }

    // æ’­æ”¾/æš‚åœæ§åˆ¶
    playBtn.addEventListener('click', () => {
      if (!audioBuffer) {
        status.textContent = 'è¯·å…ˆä¸Šä¼ éŸ³ä¹æ–‡ä»¶';
        return;
      }

      if (isPlaying) {
        // æš‚åœæ’­æ”¾ï¼ˆéœ€è¦é‡æ–°åˆ›å»ºæºèŠ‚ç‚¹æ‰èƒ½æš‚åœï¼‰
        stopPlayback();
        status.textContent = 'å·²æš‚åœ';
      } else {
        // å¼€å§‹æ’­æ”¾
        createAudioChain(currentGain);
      }
    });

    // åœæ­¢æ§åˆ¶
    stopBtn.addEventListener('click', () => {
      stopPlayback();
      status.textContent = 'å·²åœæ­¢';
    });

    // Gain å€¼é€‰æ‹©
    gainOptions.forEach(option => {
      option.addEventListener('click', () => {
        // æ›´æ–° UI
        gainOptions.forEach(opt => opt.classList.remove('active'));
        option.classList.add('active');
        
        // è·å–æ–°çš„ Gain å€¼
        const newGain = parseFloat(option.dataset.gain);
        currentGain = newGain;
        
        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°åˆ›å»ºéŸ³é¢‘é“¾ä»¥åº”ç”¨æ–°çš„ Gain å€¼
        if (isPlaying && sourceNode) {
          createAudioChain(newGain);
        }
        
        // æ›´æ–°çŠ¶æ€
        status.textContent = `Gain å€¼å·²åˆ‡æ¢ä¸º ${newGain}`;
      });
    });

    // åˆå§‹åŒ–ç”»å¸ƒ
    function initCanvas() {
      const waveformCtx = waveformCanvas.getContext('2d');
      const spectrumCtx = spectrumCanvas.getContext('2d');
      
      // è®¾ç½®ç”»å¸ƒå°ºå¯¸
      waveformCanvas.width = waveformCanvas.offsetWidth;
      waveformCanvas.height = 300;
      spectrumCanvas.width = spectrumCanvas.offsetWidth;
      spectrumCanvas.height = 300;
    }

    // å¼€å§‹å¯è§†åŒ–
    function startVisualization() {
      if (!analyserNode) return;

      const waveformCtx = waveformCanvas.getContext('2d');
      const spectrumCtx = spectrumCanvas.getContext('2d');
      
      // åˆ›å»ºæ•°æ®æ•°ç»„
      const bufferLength = analyserNode.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      const waveformData = new Uint8Array(analyserNode.fftSize);

      let clippingDetected = false;

      function draw() {
        if (!isPlaying || !analyserNode) {
          return;
        }

        // è·å–æ—¶åŸŸæ•°æ®ï¼ˆç”¨äºæ³¢å½¢å›¾ï¼‰
        analyserNode.getByteTimeDomainData(waveformData);
        
        // è·å–é¢‘åŸŸæ•°æ®ï¼ˆç”¨äºé¢‘è°±å›¾ï¼‰
        analyserNode.getByteFrequencyData(dataArray);

        // æ£€æµ‹å‰Šæ³¢ï¼ˆæ£€æŸ¥æ—¶åŸŸæ•°æ®æ˜¯å¦è¾¾åˆ°æœ€å¤§å€¼æˆ–æœ€å°å€¼ï¼‰
        clippingDetected = false;
        for (let i = 0; i < waveformData.length; i++) {
          // å¦‚æœå€¼æ¥è¿‘ 0 æˆ– 255ï¼Œå¯èƒ½å‘ç”Ÿå‰Šæ³¢
          if (waveformData[i] <= 1 || waveformData[i] >= 254) {
            clippingDetected = true;
            break;
          }
        }

        // æ›´æ–°å‰Šæ³¢æŒ‡ç¤ºå™¨
        const indicator = document.getElementById(`indicator${currentGain}`);
        if (indicator) {
          if (clippingDetected) {
            indicator.classList.add('active');
          } else {
            indicator.classList.remove('active');
          }
        }

        // ç»˜åˆ¶æ³¢å½¢å›¾
        waveformCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);

        waveformCtx.lineWidth = 2;
        waveformCtx.strokeStyle = clippingDetected ? '#ff4444' : '#4facfe';
        waveformCtx.beginPath();

        const sliceWidth = waveformCanvas.width / waveformData.length;
        let x = 0;

        for (let i = 0; i < waveformData.length; i++) {
          const v = waveformData[i] / 128.0;
          const y = (v * waveformCanvas.height) / 2;

          if (i === 0) {
            waveformCtx.moveTo(x, y);
          } else {
            waveformCtx.lineTo(x, y);
          }

          x += sliceWidth;
        }

        waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
        waveformCtx.stroke();

        // ç»˜åˆ¶å‰Šæ³¢è­¦å‘Šçº¿
        if (clippingDetected) {
          waveformCtx.strokeStyle = '#ff4444';
          waveformCtx.lineWidth = 1;
          waveformCtx.setLineDash([5, 5]);
          waveformCtx.beginPath();
          waveformCtx.moveTo(0, 0);
          waveformCtx.lineTo(waveformCanvas.width, 0);
          waveformCtx.moveTo(0, waveformCanvas.height);
          waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height);
          waveformCtx.stroke();
          waveformCtx.setLineDash([]);
        }

        // ç»˜åˆ¶é¢‘è°±å›¾
        spectrumCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        spectrumCtx.fillRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);

        const barWidth = (spectrumCanvas.width / bufferLength) * 2.5;
        let barX = 0;

        for (let i = 0; i < bufferLength; i++) {
          const barHeight = (dataArray[i] / 255) * spectrumCanvas.height;

          // ä½¿ç”¨æ¸å˜è‰²
          const gradient = spectrumCtx.createLinearGradient(0, spectrumCanvas.height - barHeight, 0, spectrumCanvas.height);
          gradient.addColorStop(0, clippingDetected ? '#ff4444' : '#4facfe');
          gradient.addColorStop(1, clippingDetected ? '#ff8888' : '#00f2fe');

          spectrumCtx.fillStyle = gradient;
          spectrumCtx.fillRect(barX, spectrumCanvas.height - barHeight, barWidth, barHeight);

          barX += barWidth + 1;
        }

        // ç»§ç»­åŠ¨ç”»
        animationFrameId = requestAnimationFrame(draw);
      }

      draw();
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç”»å¸ƒ
    window.addEventListener('load', () => {
      initCanvas();
    });

    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°åˆå§‹åŒ–ç”»å¸ƒ
    window.addEventListener('resize', () => {
      initCanvas();
    });

    // ç”¨æˆ·äº¤äº’æ—¶æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡
    document.addEventListener('click', () => {
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
    });
  </script>
</body>
</html>

